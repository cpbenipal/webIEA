"use strict";function _classCallCheck(n,t){if(!(n instanceof t))throw new TypeError("Cannot call a class as a function");}function _inherits(n,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);n.prototype=Object.create(t&&t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}});t&&(Object.setPrototypeOf?Object.setPrototypeOf(n,t):n.__proto__=t)}var _createClass=function(){function n(n,t){for(var i,r=0;r<t.length;r++)i=t[r],i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(n,i.key,i)}return function(t,i,r){return i&&n(t.prototype,i),r&&n(t,r),t}}(),_get2=function(n,t,i){var e=!0,r,f,o;n:while(e){var u=n,s=t,h=i;if(e=!1,u===null&&(u=Function.prototype),r=Object.getOwnPropertyDescriptor(u,s),r===undefined){if(f=Object.getPrototypeOf(u),f===null)return undefined;n=f;t=s;i=h;e=!0;r=f=undefined;continue n}else return"value"in r?r.value:(o=r.get,o===undefined)?undefined:o.call(h)}},EventManager=EventManager||{},EventManagerContactsEnumeration=function(n){function t(n){var i,r,u;_classCallCheck(this,t);_get2(Object.getPrototypeOf(t.prototype),"constructor",this).call(this);EventManager.bus.installTo(this);for(i in EventManager.settings.Events.contactsEnumeration)r=this[i],u=EventManager.settings.Events.contactsEnumeration[i],EventManager.bus.subscribe(u,r);setTimeout(function(){EventManager.bus.publish(EventManager.settings.Events.contactsEnumeration.endCallback,n)},4e3)}return _inherits(t,n),_createClass(t,[{key:"endCallback",value:function(n){n.rowId=$("[class*='dxtlFocusedNode'] .fp_textTreeListNode").attr("data-rowid");n.publish=!1;t.toogleContactTab(n)}},{key:"updateByPathFolder",value:function(n){var i,r;for(n=EventManager.tools.getBrowser(n),n.requestUrl="ContactsEnumeration/"+n.typeBlock+"_Update",n.classBlock="fp_contactsEnumeration",i=$(".flexpage-blockWrapper ."+n.classBlock),i.length==0&&fp_settings.debug==!0&&console.log("No "+n.classBlock+". maybe error updateByPathFolder"),r=0;r<i.length;r++)n=_get2(Object.getPrototypeOf(t.prototype),"updateByPathFolder",this).call(this,n,i[r]),n.initPerformCallback||(n=t.toogleContactTab(n),n.publish==!0&&EventManager.bus.publish(EventManager.settings.Events.service.updateByPathFolder,n))}},{key:"showContextMenu",value:function(n){var u,i,f,r,t;if(n.blockCss="#fp_ContactsEnumeration_Grid"+n.ID+"_DXMainTable",u=n.event,u.type="click",EventManager.tools.applyRename(u),n.$elemClick=$(n.event.htmlEvent.target),n.$block=n.$elemClick.closest("#b"+n.ID),n.$block.find(".fp_freeze").length===0)for(n=EventManager.tools.getBrowser(n),n.classRow="fp_contactValue",i=EventManager.tools.showContextMenu_CheckAttrs(n),i==null||(n=i),n.path=n.$block.find("[name='SelectFolderName']").val()||n.$block.find("[name='PWFolderName']").val(),n.path||(n.path="\\"),n.$focusedNode=$("[class*='dxtlFocusedNode'] .fp_textTreeListNode"),n.showNotifications=n.$focusedNode.attr("data-showNotifications")=="True",n.showSelectionBoxes=fp_settings["showSelectionBoxes"+n.ID]=="True",n.perm=parseInt(n.$focusedNode.attr("data-perm")),n=EventManager.tools.showContextMenu_CopyAttrs(n),n=EventManager.tools.showContextMenu(n),f=eval("PopupMenu"+n.ID),r=0;r<f.GetItemCount();r++)if(t=f.GetItem(r),n.typeContextMenu=="Block")switch(t.name){case"Refresh":break;case"Navigate":t.SetVisible(i!=null);break;case"AddPerson":case"AddCompany":t.SetVisible(fp_settings.isContactsAdmin);break;case"AddContact":t.SetVisible(n.path!=="\\"&&fp_settings.isContactsAdmin);break;case"DeleteContact":t.SetVisible(i!=null&&n.path!=="\\"&&fp_settings.isContactsAdmin);break;default:t.SetVisible(!1)}else if(n.typeContextMenu=="Contacts")switch(t.name){case"Refresh":break;case"Navigate":t.SetVisible(i!=null);break;case"AddPerson":case"AddCompany":t.SetVisible(fp_settings.isContactsAdmin);break;case"Delete":t.SetVisible(i!=null&&fp_settings.isContactsAdmin);break;default:t.SetVisible(!1)}else if(n.typeContextMenu=="Browser")switch(t.name){case"Refresh":break;case"Navigate":t.SetVisible(i!=null);break;case"AddContact":t.SetVisible(n.path!=="\\"&&(n.perm&1)>0);break;case"DeleteContact":t.SetVisible(i!=null&&n.path!=="\\"&&(n.perm&1)>0);break;case"EmailOverriding":t.SetVisible(i!=null&&!n.showNotifications&&!n.showSelectionBoxes&&(n.perm&32)>0);break;case"Notifications":t.SetVisible(i!=null&&n.showNotifications&&!n.showSelectionBoxes&&(n.perm&32)>0);break;case"Properties":t.SetVisible(i!=null);break;default:t.SetVisible(!1)}else switch(t.name){case"Refresh":break;default:t.SetVisible(!1)}}},{key:"clickContextMenu",value:function(n){var i,r,u;if(n.typeBlock="ContactsEnumeration",n.classBlock="fp_contactsEnumeration",n.requestUrl="ContactsEnumeration/"+n.typeBlock,n.event.item){if(i=EventManager.tools.clickContextMenu_GetAttrs(n),i==null||(n=i),n.path=n.$block.find("[name='SelectFolderName']").val()||n.$block.find("[name='PWFolderName']").val(),n.$focusedNode=$("[class*='dxtlFocusedNode'] .fp_textTreeListNode"),n.folderId=parseInt(n.$focusedNode.attr("data-rowid")),n.event.item.name==="Properties"){if(i==null)return;r=$("div.fp_contactValue[data-rowid="+n.rowId+"]")[0];u=r.innerText;fp_popupControlOpen({command:"edit",blocklistID:"0",blockType:"ObjectProperties",blockAlias:"",blockID:n.shortcutId,title:"Properties: "+u,parameters:"contact"},function(t){t&&EventManager.tools.RefreshGrid(n)})}else if(n.event.item.name==="AddContact")n.command="add",EventManager.bus.publish(EventManager.settings.Events.contactsEnumeration.addContactToFolder,n);else if(n.event.item.name==="AddPerson"){if(i==null)return;EventManager.bus.publish(EventManager.settings.Events.contactsEnumeration.addPerson,n)}else if(n.event.item.name==="AddCompany"){if(i==null)return;EventManager.bus.publish(EventManager.settings.Events.contactsEnumeration.addCompany,n)}else if(n.event.item.name==="DeleteContact"){if(i==null)return;n.command="remove";EventManager.bus.publish(EventManager.settings.Events.contactsEnumeration.deleteContactToFolder,n)}else if(n.event.item.name==="Delete"){if(i==null)return;n.command="delete";EventManager.bus.publish(EventManager.settings.Events.contactsEnumeration.deleteContact,n)}else n.event.item.name==="Refresh"?t.refreshContent(n):n.event.item.name==="Navigate"?window.open("/Home/Contacts/"+n.rowId+"?type="+(n.contactType=="1"?"Person":"Company")):n.event.item.name==="Notifications"?fp_popupControlOpen({command:"edit",blockType:"Notifications",parameters:'{"folderID":'+n.folderId+', "ContactID":'+n.rowId+', "ContactShortcutID":'+n.shortcutId+"}",controller:"Admin",action:"Notifications"+(n.contactType=="1"?"Person":"Company")+"Popup"}):n.event.item.name==="EmailOverriding"&&fp_popupControlOpen({command:"edit",blockType:"EmailOverriding",parameters:'{"folderID":'+n.folderId+', "ContactID":'+n.rowId+', "ContactShortcutID":'+n.shortcutId+"}",controller:"Admin",action:"EmailOverriding"+(n.contactType=="1"?"Person":"Company")+"Popup"});return!1}}},{key:"addContactToFolder",value:function(n){n.typeBlock="ContactsEnumeration";n.classBlock="fp_contactsEnumeration";n.requestUrl="ContactsEnumeration/UpdateContactsEnumerationFolder";fp_popupControlOpen({command:"choose",blockType:"ContactsEnumerationSelector",alwaysCallOnClose:!0,title:n.path,controller:"Flexpage"},function(){});window.flexpage.fp_afterObjectSelected=function(t){n.requestParameters=[];$(t).each(function(t,i){i.contactID&&(n.contactID=parseInt(i.contactID),n.callbackSucceed=function(){},n.requestParameters.push({contactID:n.contactID,path:n.path,command:n.command}))});n.requestParameters={parameters:JSON.stringify(n.requestParameters)};EventManager.bus.publish(EventManager.settings.Events.service.addContactToFolder,n);$(".fp_contactsEnumeration").each(function(t,i){EventManager.tools.showLoading(n);n.ID=$(i).closest(".flexpage-blockWrapper").attr("id");n.ID=parseInt(n.ID.replace("b",""));setTimeout(function(){EventManager.tools.RefreshGrid(n)},1e3)})}}},{key:"deleteContact",value:function(n){var t=$(n.$block).find("[class*='dxgvSelectedRow'],[class*='dxtlFocusedNode']");fp_settings.debug==!0&&console.log("$rows.length:"+t.length);n.typeBlock="ContactsEnumeration";n.classBlock="fp_contactsEnumeration";n.requestUrl="ContactsEnumeration/UpdateContactsEnumerationFolder";fp_ConfirmDialog("Delete","Do you really want to delete selected contacts? They can't be restored afterwards.",function(){if(t.length>0){var r=t.length,i=0;t.each(function(t,u){n.$row=$(u);n.rowId=$(u).find(".fp_contactValue").attr("data-rowid");n.contactID=parseInt(n.rowId);n.contactType=$(u).find(".fp_contactValue").attr("data-contactType");n.requestParameters={parameters:JSON.stringify([{contactID:n.contactID,contactType:n.contactType,command:n.command}])};n.callbackSucceed=function(t,u,f,e,o){i++;o.success?(fp_settings.debug==!0&&console.log("callbackSucceed indexCallback:"+i),$(n.$row).remove(),i==r&&(EventManager.tools.RefreshGrid(n),fp_settings.debug==!0&&console.log("indexCallback == length"))):fp_ConfirmDialog(o.error.title,o.error.message,function(){i==r&&(EventManager.tools.RefreshGrid(n),fp_settings.debug==!0&&console.log("indexCallback == length"))},function(){i==r&&(EventManager.tools.RefreshGrid(n),fp_settings.debug==!0&&console.log("indexCallback == length"))})};n.callbackError=function(n,t,i,r,u){fp_ConfirmDialog(u.error.title,u.error.message,function(){},function(){})};EventManager.bus.publish(EventManager.settings.Events.service.deleteContact,n)})}else n.contactID=parseInt(n.rowId),n.callbackSucceed=function(t,i,r,u,f){f.success?EventManager.tools.RefreshGrid(n):fp_ConfirmDialog(f.error.title,f.error.message,function(){},function(){})},n.callbackError=function(n,t,i,r,u){fp_ConfirmDialog(u.error.title,u.error.message,function(){},function(){})},n.requestParameters={parameters:JSON.stringify([{contactID:n.contactID,contactType:n.contactType,command:n.command}])},EventManager.bus.publish(EventManager.settings.Events.service.deleteContact,n)})}},{key:"deleteContactToFolder",value:function(n){var t=$(n.$block).find("[class*='dxgvSelectedRow']");fp_settings.debug==!0&&console.log("$rows.length:"+t.length);t.length>0?fp_ConfirmDialog("Delete","Do you really want to delete the selected contacts?",function(){var r=t.length,i=0;t.each(function(t,u){EventManager.tools.showLoading(n);n.$row=$(u);n.rowId=$(u).find(".fp_contactValue").attr("data-rowid");fp_settings.debug==!0&&console.log("rowId:"+n.rowId);n.typeBlock="ContactsEnumeration";n.classBlock="fp_contactsEnumeration";n.requestUrl="ContactsEnumeration/UpdateContactsEnumerationFolder";n.contactID=parseInt(n.rowId);n.callbackSucceed=function(){i++;fp_settings.debug==!0&&console.log("callbackSucceed indexCallback:"+i);$(n.$row).remove();i==r&&(fp_settings.debug==!0&&console.log("indexCallback == length"),EventManager.tools.RefreshGrid(n),EventManager.tools.hideLoading(n))};n.requestParameters={parameters:JSON.stringify([{contactID:n.contactID,contactType:n.contactType,path:n.path,command:n.command}])};EventManager.bus.publish(EventManager.settings.Events.service.deleteContactToFolder,n)})}):(n.typeBlock="ContactsEnumeration",n.classBlock="fp_contactsEnumeration",n.requestUrl="ContactsEnumeration/UpdateContactsEnumerationFolder",EventManager.tools.showLoading(n),n.contactID=parseInt(n.rowId),n.callbackSucceed=function(){EventManager.tools.RefreshGrid(n);EventManager.tools.hideLoading(n)},n.requestParameters={parameters:JSON.stringify([{contactID:n.contactID,contactType:n.contactType,path:n.path,command:n.command}])},EventManager.bus.publish(EventManager.settings.Events.service.deleteContactToFolder,n))}},{key:"addPerson",value:function(){fp_popupControlOpen({command:"addContact",blocklistID:"0",blockType:"ContactAdd",blockAlias:"",title:"Person",controller:"Flexpage",OneButtonText:"ADD"},function(){})}},{key:"addCompany",value:function(){fp_popupControlOpen({command:"addContact",blocklistID:"0",blockType:"ContactAdd",blockAlias:"",title:"Company",controller:"Flexpage",OneButtonText:"ADD"},function(){})}},{key:"rowClick",value:function(n){var i;n.typeBlock="ContactsEnumeration";n.requestUrl="ContactsEnumeration/"+n.typeBlock+"_ContactDetails";n.classBlock="fp_contactsEnumeration";_get2(Object.getPrototypeOf(t.prototype),"rowClick",this).call(this,n);var r=$(".flexpage-blockWrapper#b"+n.ID),f=r.find("."+n.classBlock),u=f.attr("data-name");n.contactID=null;n.contactType=null;i=n.event.htmlEvent?!0:!1;i&&($(n.event.htmlEvent.target).hasClass(".fp_contactValue")&&(n.$elem=$(n.event.htmlEvent.target),n.contactID=$(n.$elem).attr("data-rowId")),n.contactID||(n.$elem=$(n.event.htmlEvent.target).find(".fp_contactValue"),n.contactID=$(n.$elem).attr("data-rowId")),n.contactID||(n.$elem=$(n.event.htmlEvent.target).closest(".fp_contactValue"),n.contactID=$(n.$elem).attr("data-rowId")));n.contactID||(n.$elem=$(r).find("[class*='dxgvSelectedRow'] .fp_contactValue"),n.contactID=$(n.$elem).attr("data-rowId"));u&&(n.contactType=$(n.$elem).attr("data-contactType"),$(".fp_contactDetails[data-alias="+u+"]").each(function(t,r){var u={},o,e,f;if(u.typeBlock="ContactDetails",o=!1,n.contactID?u.requestUrl="ContactDetails/"+u.typeBlock:(u.requestUrl="ContactDetails/"+u.typeBlock+"Empty",o=!0),u.classBlock="fp_contactDetails",u.$block=$(r).closest(".flexpage-blockWrapper"),u.ID=u.$block.attr("id"),u.ID){if(u.ID=parseInt(u.ID.replace("b","")),u.contactID=n.contactID,u.contactType=n.contactType,e=u.$block.find("[data-contactID]").attr("data-contactID"),n.contactID&&e&&n.contactID==e&&!i)return;if(f=u.$block.find(".dxtc-activeTab:visible"),f.length>0&&(u.selectTabIndex=f.attr("id"),u.selectTabIndex&&(u.selectTabIndex=u.selectTabIndex.replace("tabControl"+u.ID+"_AT",""),u.selectTab=f.text(),u.selectTab&&(u.selectTab=u.selectTab.replace(" ","")))),n.contactID)u.requestParameters={ID:u.ID,selectTabIndex:u.selectTabIndex,selectTab:u.selectTab,contactID:n.contactID,contactType:n.contactType,edit:!1};else if(u.requestParameters={ID:u.ID},f.length==0)return;e!=n.contactID&&(EventManager.tools.showLoading(u),u.callbackSucceed=function(n,t,i){EventManager.tools.UpdateBlock(n,t,i,u);u.requestUrl="ContactDetails/"+u.typeBlock+"_UpdateTab";EventManagerContactDetails.bind(u)},EventManager.bus.publish(EventManager.settings.Events.service.updateContactDetails,u))}}))}},{key:"updateGeneralInfo",value:function(n){return n.edit==!1&&(n.$row=$(" .fieldName-PersonCompanyName .fp_contactValue[data-rowId="+n.contactID+"][data-contactType="+(n.contactType=="Person"?1:2)+"]"),$(n.$row).text(n.name)),n}},{key:"updateTelecoms",value:function(n){var t,i;if($(n.s.mainElement).find("[class*='dxgvEditForm']").length==0){n.$row=$(" .fieldName-PersonCompanyEmail .fp_contactValue[data-rowId="+n.contactID+"][data-contactType="+(n.contactType=="Person"?1:2)+"]");var r=$(n.s.mainElement).find("[class*='dxgvDataRow']"),f=[],e=[];for(t=0;t<r.length;t++){var s=$(r[t]).find("[data-field='IsDefault']").attr("data-text"),u=$(r[t]).find("[data-field='TypeID']").text(),o=$(r[t]).find("[data-field='Value']").text();s=="Checked"?(u=="E-Mail"||u=="E-mail")&&e.push(o):(u=="E-Mail"||u=="E-mail")&&f.push(o)}i=e[0];i?$(n.$row).text(i):(i=f[0],i&&$(n.$row).text(i))}return n}},{key:"updateCustomProperties",value:function(){}},{key:"addNewContact",value:function(n){n.requestUrl="ContactsEnumeration/AddContact";n.requestParameters={id:"addContactForm",contact:n.contact};n.callbackSucceed=function(n,t,i,r,u){window.open("/Home/Contacts/"+u.id+"?type="+u.type)};n.async=!1;EventManager.bus.publish(EventManager.settings.Events.service.addNewContact,n)}}],[{key:"refreshContent",value:function(n){var t=window["fp_refresh"+n.ID];typeof t=="function"&&t()}},{key:"toogleContactTab",value:function(n){var r,u,i;return n=EventManager.tools.getBrowser(n),n.$browser.length>0&&n.rowId&&(n.$row=$("[data-rowid="+n.rowId+"]"),r=n.$row.attr("data-showContacts")=="True",n=EventManager.tools.getBrowser(n),r?n.$browser.find("#tabControl"+n.$browser.ID+"_T1").removeClass("hidden"):(n.$browser.find("#tabControl"+n.$browser.ID+"_T0").click(),n.$browser.find("#tabControl"+n.$browser.ID+"_T1").addClass("hidden")),n=EventManager.tools.getBrowser(n),u=n.$browser.find(".flexpage-blockWrapper .fp_contactsEnumeration"),n=_get(Object.getPrototypeOf(t.prototype),"updateByPathFolder",this).call(this,n,u[0]),i=eval("fp_ContactsEnumeration_Grid"+n.ID),fp_settings.debug==!0&&console.log("callback:"+i.callback),n.$browser.find("#tabControl"+n.$browser.ID+"_AT1:visible").length==0||n.initPerformCallback||i.callback||(n.publish==!0&&(n.initPerformCallback=!0,EventManager.bus.publish(EventManager.settings.Events.contactsEnumeration.updateByPathFolder,n)),n.refreshContacts&&t.refreshContent(n))),n}}]),t}(EventManagerContent);