"use strict";function _classCallCheck(n,t){if(!(n instanceof t))throw new TypeError("Cannot call a class as a function");}function _inherits(n,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);n.prototype=Object.create(t&&t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}});t&&(Object.setPrototypeOf?Object.setPrototypeOf(n,t):n.__proto__=t)}var _createClass=function(){function n(n,t){for(var i,r=0;r<t.length;r++)i=t[r],i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(n,i.key,i)}return function(t,i,r){return i&&n(t.prototype,i),r&&n(t,r),t}}(),_get=function(n,t,i){var e=!0,r,f,o;n:while(e){var u=n,s=t,h=i;if(e=!1,u===null&&(u=Function.prototype),r=Object.getOwnPropertyDescriptor(u,s),r===undefined){if(f=Object.getPrototypeOf(u),f===null)return undefined;n=f;t=s;i=h;e=!0;r=f=undefined;continue n}else return"value"in r?r.value:(o=r.get,o===undefined)?undefined:o.call(h)}},EventManager=EventManager||{},EventManagerContactsAdvancedSearch=function(n){function t(n){var f,i,r,u;_classCallCheck(this,t);_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this);EventManager.bus.installTo(this);f=this;for(i in EventManager.settings.Events.contactsAdvancedSearch)r=this[i],u=EventManager.settings.Events.contactsAdvancedSearch[i],EventManager.bus.subscribe(u,r);n.nameHistory=$("#HistoryName").val();n.historyStart=$("#HistoryStart").val();n.userName=$("#UserName").val();n.decode=!0;n=t.getStartXml(n);n.xml=n.StartXML;n=t.setStartXml(n);n=t.getHistoryBPMNxmls(n);n=t.setHistoryStepArrows(n)}return _inherits(t,n),_createClass(t,[{key:"search",value:function(n){n.requestUrl="AdvancedSearch/ContactsAdvancedSearch_Result";n.requestParameters={xml:n.xml};n.callbackSucceed=function(i){$("#fp_resultAdvancedSearch").html(i);var r=window.fp_changeActiveTab;r();t.unbind(n);t.bind(n)};fp_settings.debug==!0&&console.log(n.requestParameters.xml);EventManager.bus.publish(EventManager.settings.Events.service.setContactsAdvancedSearch,n)}},{key:"exportToFile",value:function(n){n.requestUrl="AdvancedSearch/ContactsAdvancedSearch_Export";n.requestParameters={xml:n.xml,path:n.path,folderId:n.folderId,name:n.name};var t=n.callbackSucceed;n.callbackSucceed=function(n,i,r,u,f){fp_settings.debug==!0&&console.log("export");t(n,i,r,u,f)};fp_settings.debug==!0&&console.log(n.requestParameters.xml);n.callbackError=function(t,i,r,u,f){fp_ConfirmDialog(f.error.title,f.error.message,function(){f.error.overwrite==!0&&(n.requestParameters.append("overwrite",!0),EventManager.bus.publish(EventManager.settings.Events.service.setContactsAdvancedSearch,n))},function(){})};EventManager.bus.publish(EventManager.settings.Events.service.setContactsAdvancedSearch,n)}},{key:"importToFile",value:function(n){n.requestUrl="AdvancedSearch/ContactsAdvancedSearch_Import";n.requestParameters={xml:n.xml,bpmnXml:n.bpmnXml};var i=n.callbackSucceed;n.callbackSucceed=function(r,u,f,e,o){if(o.result){fp_settings.debug==!0&&console.log("import");i(r,u,f,e,o);var e={ID:n.ID};e.xml=o.result;e.StartXML=o.result;e=t.removeDiagramHistory(e)}};EventManager.bus.publish(EventManager.settings.Events.service.setContactsAdvancedSearch,n)}},{key:"openToBrowser",value:function(){fp_popupControlOpen({command:"browserchoose",blockType:"BrowserSelector",action:"BrowserSelector",controller:"FlexPage",alwaysCallOnClose:!0},function(){})}},{key:"openFile",value:function(n){n.requestUrl="AdvancedSearch/ContactsAdvancedSearch_Open";n.requestParameters={fileID:n.fileID};var i=n.callbackSucceed;n.callbackSucceed=function(r,u,f,e,o){if(o.result){fp_settings.debug==!0&&console.log("open");i(r,u,f,e,o);var e={ID:n.ID};e.xml=o.result;e.StartXML=o.result;e=t.removeDiagramHistory(e)}};EventManager.bus.publish(EventManager.settings.Events.service.setContactsAdvancedSearch,n)}},{key:"saveToFolder",value:function(){fp_popupControlOpen({command:"browserchoose",blockType:"FolderSaveAsContactsSelector",action:"FolderSaveAsContactsSelector",controller:"FlexPage",alwaysCallOnClose:!0},function(){})}},{key:"linkFolder",value:function(n){n.requestUrl="Admin/ContactsAdvancedSearch_CheckFolderDL";n.requestParameters={path:n.path};n.callbackSucceed=function(i,r,u,f,e){e.result==!0?t.exportToFolder(n):e.result==!1&&fp_ConfirmDialog("Covert","The selected folder is not distribution list. Do you want to convert it to distribution list?",function(){n.requestUrl="Admin/ContactsAdvancedSearch_ConvertFoldertoDL";n.requestParameters={path:n.path};n.callbackSucceed=function(i,r,u,f,e){e.result==!0?t.exportToFolder(n):e.result==!1&&fp_ConfirmDialog("Error","Folder not converted",function(){})};EventManager.bus.publish(EventManager.settings.Events.service.setContactsAdvancedSearch,n)})};fp_settings.debug==!0&&console.log(n.requestParameters.path);EventManager.bus.publish(EventManager.settings.Events.service.setContactsAdvancedSearch,n)}},{key:"newFile",value:function(n){n.xml="";n.StartXML="";n=t.removeDiagramHistory(n)}},{key:"setHistoryStep",value:function(n){n.nameHistory=$("#HistoryName").val();n.historyStart=$("#HistoryStart").val();n.userName=$("#UserName").val();fp_settings.debug==!0&&console.log("args.step:"+n.step);n=t.getHistoryBPMNxmls(n);n=t.setHistoryStepArrows(n);n.nowStep+n.step>=0&&n.nowStep+n.step<n.BPMNxmls.length&&(n.nowStep=n.nowStep+n.step,n.BPMNxmls[n.nowStep]&&(fp_settings.debug==!0&&console.log("set step:"+n.nowStep+", localStorage step:"+(n.BPMNxmls.length-n.nowStep)),$("#HistoryStep").val(n.nowStep),n.callbackSucceed(n.BPMNxmls[n.nowStep].xml),n.BPMNxmls[n.nowStep].xml&&(n.requestParameters={xml:n.BPMNxmls[n.nowStep].xml},n.requestUrl="AdvancedSearch/ContactsAdvancedSearch_SaveXmlChanges",n.callbackSucceed=function(){},EventManager.bus.publish(EventManager.settings.Events.service.setContactsAdvancedSearch,n))))}},{key:"saveXmlChanges",value:function(n){n.nameHistory=$("#HistoryName").val();n.historyStart=$("#HistoryStart").val();n.userName=$("#UserName").val();n=t.getHistoryBPMNxmls(n);n.temlBPMNXml={xml:n.xml,datetime:Date.now()};n.BPMNxmls.unshift(n.temlBPMNXml);n.temlBPMNXml=JSON.stringify(n.temlBPMNXml);localStorage.setItem(n.nameHistory+"-"+n.userName+"-"+n.BPMNxmls.length,n.temlBPMNXml,3e5);n.xml&&(n.requestParameters={xml:n.xml},n.requestUrl="AdvancedSearch/ContactsAdvancedSearch_SaveXmlChanges",n.callbackSucceed=function(){},EventManager.bus.publish(EventManager.settings.Events.service.setContactsAdvancedSearch,n));n=t.getHistoryBPMNxmls(n);n=t.setHistoryStepArrows(n)}}],[{key:"setStartXml",value:function(n){return n.temlBPMNXml=JSON.stringify(n.temlBPMNXml),localStorage.setItem(n.nameHistory+"-"+n.userName+"-"+n.historyStart,n.temlBPMNXml,3e5),localStorage.getItem(n.nameHistory+"-"+n.userName+"-1")||EventManager.bus.publish(EventManager.settings.Events.contactsAdvancedSearch.saveXmlChanges,n),n}},{key:"getStartXml",value:function(n){return n.decode&&(n.StartXML=$("<div><\/div>").html(n.StartXML).text(),n.StartXML[0]=='"'&&(n.StartXML=n.StartXML.substr(1,n.StartXML.length-2))),n.temlBPMNXml={xml:n.StartXML,datetime:Date.now()},n}},{key:"removeDiagramHistory",value:function(n){n.nameHistory=$("#HistoryName").val();n.historyStart=$("#HistoryStart").val();n.userName=$("#UserName").val();var i=0;n.temlBPMNXml=null;do i++,n.temlBPMNXml=localStorage.getItem(n.nameHistory+"-"+n.userName+"-"+i),n.temlBPMNXml&&localStorage.removeItem(n.nameHistory+"-"+n.userName+"-"+i);while(n.temlBPMNXml);return $("#HistoryStep").val(0),n=t.getStartXml(n),t.setStartXml(n)}},{key:"getHistoryBPMNxmls",value:function(n){n.BPMNxmls=[];var t=0;n.temlBPMNXml=null;do t++,n.temlBPMNXml=localStorage.getItem(n.nameHistory+"-"+n.userName+"-"+t),n.temlBPMNXml&&n.BPMNxmls.unshift(JSON.parse(n.temlBPMNXml));while(n.temlBPMNXml);return n}},{key:"setHistoryStepArrows",value:function(n){return n.nowStep=parseInt($("#HistoryStep").val()),n.step||(n.step=0),n.BPMNxmls.length>1&&n.nowStep+n.step<n.BPMNxmls.length-1?$(".fp_toolbar-buttons__button_undo").removeClass("fp_toolbar-buttons__button_inactive"):$(".fp_toolbar-buttons__button_undo").addClass("fp_toolbar-buttons__button_inactive"),n.BPMNxmls.length>1&&n.nowStep+n.step>0?$(".fp_toolbar-buttons__button_redo").removeClass("fp_toolbar-buttons__button_inactive"):$(".fp_toolbar-buttons__button_redo").addClass("fp_toolbar-buttons__button_inactive"),n}},{key:"exportToFolder",value:function(n){var t=$("#fp_resultAdvancedSearchGUID").val();n.requestUrl="Admin/ContactsAdvancedSearch_Export";n.requestParameters={xml:t,path:n.path};EventManager.bus.publish(EventManager.settings.Events.service.setContactsAdvancedSearch,n)}},{key:"bind",value:function(n){$(".fp_advancedSearch-btn__export").on("click",{args:n},t["export"]);$(".fp_advancedSearch-btn__export_to_xls").on("click",{args:n},t.exportToXls)}},{key:"unbind",value:function(){$(".fp_advancedSearch-btn__export").off("click",t["export"]);$(".fp_advancedSearch-btn__export_to_xls").off("click",t.exportToXls)}},{key:"export",value:function(n){var t=n.data.args;fp_popupControlOpen({command:"choose",blockType:"FolderSaveContactsSelector",action:"GetPopupChooseObjectContent",controller:"FlexPage",alwaysCallOnClose:!0,title:"Export results"},function(){})}},{key:"exportToXls",value:function(){var n,t;window.flexpage=window.flexpage||{};window.parent.flexpage.ExportXls=$("#SearchXml").val();window.flexpage.isSaveEven=!1;n="?folderId="+$("#SelectFolderId").val();$("#fp_resultAdvancedSearchGUID").val()&&(t=$("#fp_resultAdvancedSearchGUID").val(),n+="&xml="+t);window.flexpage.onClose=function(){$("#dialog-iframe").remove()};window.flexpage.Download=function(n){$("#dialog-iframe").remove();location.href=n};$("<iframe/>",{id:"dialog-iframe",css:{position:"fixed",top:0,left:0,width:"100%",height:"100%",border:0,"z-index":12001},src:"/Export/ShowExportSettingsDialog"+n}).appendTo($("body"))}}]),t}(EventManagerBase);