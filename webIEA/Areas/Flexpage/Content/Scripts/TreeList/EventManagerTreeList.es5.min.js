"use strict";function _classCallCheck(n,t){if(!(n instanceof t))throw new TypeError("Cannot call a class as a function");}function _inherits(n,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);n.prototype=Object.create(t&&t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}});t&&(Object.setPrototypeOf?Object.setPrototypeOf(n,t):n.__proto__=t)}var _createClass=function(){function n(n,t){for(var i,r=0;r<t.length;r++)i=t[r],i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(n,i.key,i)}return function(t,i,r){return i&&n(t.prototype,i),r&&n(t,r),t}}(),_get=function(n,t,i){var e=!0,r,f,o;n:while(e){var u=n,s=t,h=i;if(e=!1,u===null&&(u=Function.prototype),r=Object.getOwnPropertyDescriptor(u,s),r===undefined){if(f=Object.getPrototypeOf(u),f===null)return undefined;n=f;t=s;i=h;e=!0;r=f=undefined;continue n}else return"value"in r?r.value:(o=r.get,o===undefined)?undefined:o.call(h)}},EventManager=EventManager||{},EventManagerTreeList=function(n){function t(n){_classCallCheck(this,t);_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this);EventManager.bus.installTo(this);EventManager.bus.subscribe(EventManager.settings.Events.folderTreeList.clickNode,this.clickNode);EventManager.bus.subscribe(EventManager.settings.Events.folderTreeList.showContextMenu,this.showContextMenu);EventManager.bus.subscribe(EventManager.settings.Events.folderTreeList.clickContextMenu,this.clickContextMenu);EventManager.bus.subscribe(EventManager.settings.Events.folderTreeList.renameApplyFolder,this.renameApplyFolder);EventManager.bus.subscribe(EventManager.settings.Events.folderTreeList.expandedChangingFolder,this.expandedChangingFolder);EventManager.bus.subscribe(EventManager.settings.Events.folderTreeList.endCallback,this.endCallback);var i=this;n.allowUpload&&(EventManager.bus.subscribe(EventManager.settings.Events.folderTreeList.initUpload,this.initUpload),EventManager.bus.publish(EventManager.settings.Events.folderTreeList.initUpload,n));$(".fp_folderSaveAsContactsSelector.hidden-visbility").removeClass("hidden-visbility");$(".fp_folderSaveAsContactsSelector").parent().find(".fp_browser-empty").addClass("hidden")}return _inherits(t,n),_createClass(t,[{key:"initUpload",value:function(n){$("html").on("dragover",function(n){n.preventDefault();n.stopPropagation()});$("html").on("drop",function(n){n.preventDefault();n.stopPropagation()});$(".fp_folderTreeList .upload-area").on("drop",function(t){var r,i,u;for(t.stopPropagation(),t.preventDefault(),r=t.originalEvent.dataTransfer.files,n.requestParameters=new FormData,i=0;i<r.length;i++)n.requestParameters.append("file"+i,r[i]);for(i=0;i<r.length;i++)n.requestParameters.append("file"+i+"_dateModification",new Date(r[i].lastModifiedDate||r[i].lastModified||new Date).toISOString());n.$focusedNode=$("[class*='dxtlFocusedNode'] .fp_textTreeListNode");n.dataId=$(t.target).parent().attr("data-id")||n.$focusedNode.attr("data-id");n.rowId=$(t.target).parent().attr("data-rowId")||n.$focusedNode.attr("data-rowid");n.typeBlock="FolderTreeList";n.classBlock="fp_folderTreeList";n.requestParameters.append("folderId",n.rowId);n.$block=$(t.target).closest(".flexpage-blockWrapper").first();n.ID=n.$block.attr("id");n.ID=parseInt(n.ID.replace("b",""));n.requestParameters.append("id",n.ID);u=$(t.target).parent().attr("data-path")||n.$focusedNode.attr("data-path");n.requestParameters.append("selectFolderName",u);n.folderId=n.rowId;n.requestUrl="/Flexpage/FolderTreeList_UploadFile";n.callbackSucceed=function(t,i,r,u){$(".flexpage-block-container>.fp_folderContent").each(function(t,i){n.ID=$(i).closest(".flexpage-blockWrapper").attr("id");n.ID=parseInt(n.ID.replace("b",""));n.classBlock="fp_folderContent";EventManager.tools.RefreshGrid(u)})};n.callbackError=function(n,t,i,r,u){fp_ConfirmDialog(u.error.title,u.error.message,function(){u.error.overwrite==!0&&(r.requestParameters.append("overwrite",!0),EventManager.bus.publish(EventManager.settings.Events.service.uploadFile,r))},function(){r.callbackSucceed()})};EventManager.bus.publish(EventManager.settings.Events.service.uploadFile,n)})}},{key:"expandedChangingFolder",value:function(n){n.typeBlock="FolderTreeList";n.classBlock="fp_folderTreeList";n.requestUrl="Flexpage/"+n.typeBlock+"_ExpandedChanging";n.$elem=$("#"+n.event.node.contentElementID).find(".fp_textTreeListNode");n.$block=n.$elem.closest("#b"+n.ID);n.$elem.hasClass("fp_textTreeListNodeExpanded")||(EventManager.tools.showLoading(n),n.level=parseInt(n.$elem.attr("data-level")),n.rowId=n.$elem.attr("data-rowId"),n=t.getExtendedfolderID(n),n.extendedfolderID+=","+n.rowId,n.requestParameters={ID:n.ID,folderId:n.rowId,level:n.level,extendedfolderID:n.extendedfolderID},EventManager.bus.publish(EventManager.settings.Events.service.expandedChanging,n))}},{key:"endCallback",value:function(){}},{key:"clickNode",value:function(n){n.path=$(n.e.htmlEvent.target).closest(".fp_textTreeListNode").attr("data-path")||$(n.e.htmlEvent.target).find(".fp_textTreeListNode").attr("data-path")||$(n.e.htmlEvent.target).attr("data-path");n.rowID=$(n.e.htmlEvent.target).closest(".fp_textTreeListNode").attr("data-rowID")||$(n.e.htmlEvent.target).find(".fp_textTreeListNode").attr("data-rowID")||$(n.e.htmlEvent.target).attr("data-rowID");n.name=$(n.e.htmlEvent.target).closest(".fp_textTreeListNode").attr("data-name")||$(n.e.htmlEvent.target).find(".fp_textTreeListNode").attr("data-name")||$(n.e.htmlEvent.target).attr("data-name");n.saveSelectedKey=$(n.e.htmlEvent.target).closest(".fp_textTreeListNode").attr("data-saveSelectedKey")||$(n.e.htmlEvent.target).find(".fp_textTreeListNode").attr("data-saveSelectedKey")||$(n.e.htmlEvent.target).attr("data-saveSelectedKey");EventManager.bus.publish(EventManager.settings.Events.contactsEnumeration.updateByPathFolder,{typeBlock:"ContactsEnumeration",name:n.name,classBlock:"fp_contactsEnumeration",path:n.path,rowId:n.rowID,initPerformCallback:!1,typeContextMenu:n.typeContextMenu});EventManager.bus.publish(EventManager.settings.Events.folderContent.updateByPathFolder,{typeBlock:"FolderContent",name:n.name,classBlock:"fp_folderContent",path:n.path,rowId:n.rowID,filterCustomProperties:n.filterCustomProperties,filterExtension:n.filterExtension,typeContextMenu:n.typeContextMenu});n.typeBlock="FolderTreeList";n.classBlock="fp_folderTreeList";n.requestUrl="Flexpage/"+n.typeBlock+"_ClickNode";n.requestParameters={ID:n.ID,name:n.s.name,saveSelectedKey:n.saveSelectedKey,args:JSON.stringify({path:n.path,rowId:n.rowID,name:n.s.name})};n.callbackSucceed=function(){};n.callbackError=function(){};EventManager.bus.publish(EventManager.settings.Events.service.treelistClickNode,n)}},{key:"showContextMenu",value:function(n){var e=n.event,u,i,t,f,r;if(e.type="click",EventManager.tools.applyRename(e),n.blockCss="#fp_FolderTreeList_List"+n.ID,$(n.blockCss+" .fp_textTreeListNodeInput").length===0&&(n.$elemClick=$(n.event.htmlEvent.target).parent(),n.$block=n.$elemClick.closest("#b"+n.ID),n.$block.find(".fp_freeze").length===0)){if(n.classRow="fp_textTreeListNode",n=EventManager.tools.showContextMenu_CheckAttrs(n),n==null)return;for(n.path=n.$elemClick.attr("data-path"),n.name=n.$elemClick.attr("data-name"),n.level=n.$elemClick.attr("data-level"),n.perm=parseInt(n.$elemClick.attr("data-perm")),n["export"]=n.$elemClick.attr("data-export"),n.showContacts=n.$elemClick.attr("data-showContacts")=="True",n.showNotifications=n.$elemClick.attr("data-showNotifications")=="True",isNaN(n.perm)&&(n.perm=0),EventManager.tools.showContextMenu_CopyAttrs(n),EventManager.tools.showContextMenu(n),u=eval("PopupMenu"+n.ID),i=0;i<u.GetItemCount();i++)if(t=u.GetItem(i),n.typeContextMenu=="Browser"||n.typeContextMenu=="Block")switch(t.name){case"Create":t.SetVisible(n.path==="\\"||(n.perm&1)>0);break;case"UploadFile":t.SetVisible((n.perm&1)>0);break;case"Paste":t.SetVisible((n.perm&1)>0);t.SetEnabled(EventManager.tools.get_cookie("PWBrowserCopyData")!=null);break;case"PasteShortcut":t.SetVisible((n.perm&1)>0);f=EventManager.tools.get_cookie("PWBrowserCopyData");f?(r=JSON.parse(f),t.SetEnabled(r!=null&&r.action!=="Cut"&&r.type!=="folder")):t.SetEnabled(!1);break;case"AddContact":t.SetVisible(n.path!=="\\"&&(n.perm&1)>0&&n.showContacts);break;case"Rename":t.SetVisible(n.path!=="\\"&&(n.perm&32)>0);break;case"Delete":t.SetVisible(n.path!=="\\"&&(n.perm&4)>0);break;case"Copy":t.SetVisible(n.path!=="\\"&&(n.perm&2)>0);break;case"Cut":t.SetVisible(n.path!=="\\"&&(n.perm&4)>0&&(n.perm&2)>0);break;case"Properties":t.SetVisible((n.perm&32)>0||n.isAdmin);break;case"ResetPublishingOverrides":case"ResetTimeToLeave":t.SetVisible(n.path!=="\\"&&(n.perm&32)>0&&n.showNotifications);break;case"ExportContacts":t.SetVisible(n["export"]==="True")}else switch(t.name){case"Refresh":break;default:t.SetVisible(!1)}}}},{key:"clickContextMenu",value:function(n){var i,f,r,u,e;if(n.typeBlock="FolderTreeList",n.classBlock="fp_folderTreeList",n.requestUrl="Flexpage/"+n.typeBlock+"_"+n.event.item.name,n=EventManager.tools.clickContextMenu_GetAttrs(n),n!=null){if(n=t.getExtendedfolderID(n),(n.event.item.name==="Create"||n.event.item.name==="Rename")&&(n.extendedfolderID+=n.rowId),n=t.getLevel(n),n.folderID=parseInt(n.rowId),n.requestParameters={ID:n.ID,extendedfolderID:n.extendedfolderID,folderId:n.folderID,level:n.level,maxLevel:n.maxLevel},n.event.item.name==="Create"){eval("fp_FolderTreeList_List"+n.ID).StartEditNewNode(n.rowId);$(window.document).on("keydown",function(t){if(t.keyCode===27){eval("fp_FolderTreeList_List"+n.ID).CancelEdit();return}t.keyCode===13&&eval("fp_FolderTreeList_List"+n.ID).UpdateEdit()})}else if(n.event.item.name==="AddNotification")i=$(".fp_textTreeListNode[data-rowid="+n.rowId+"] span").text(),fp_popupControlOpen({command:"notification",blocklistID:"0",blockType:"FolderNotification",blockAlias:"",action:"GetFolderNotifications",controller:"Notifications",blockID:n.rowId,title:"Folder Notifications "+i},function(){});else if(n.event.item.name==="AddContact")n.alias=n.name,n.command="add",EventManager.bus.publish(EventManager.settings.Events.contactsEnumeration.addContactToFolder,n);else if(n.event.item.name==="Rename"){eval("fp_FolderTreeList_List"+n.ID).StartEdit(n.rowId);$(window.document).on("keydown",function(t){if(t.keyCode===27){eval("fp_FolderTreeList_List"+n.ID).CancelEdit();return}t.keyCode===13&&eval("fp_FolderTreeList_List"+n.ID).UpdateEdit()})}else n.event.item.name==="Delete"?fp_ConfirmDialog("Delete","Are you sure you want to delete folder?",function(){var t=$("[class*='dxtlFocusedNode'] .fp_textTreeListNode").attr("data-path");n.path==t&&$("[data-rowId='"+n.parentId+"']").click();eval("fp_FolderTreeList_List"+n.ID).DeleteNode(n.rowId)}):n.event.item.name==="UploadFile"?n=t.bindUploadFile(n):n.event.item.name==="Properties"?(i=$(".fp_textTreeListNode[data-rowid="+n.rowId+"] span").text(),fp_popupControlOpen({command:"edit",blocklistID:"0",blockType:"ObjectProperties",blockAlias:"",blockID:n.rowId,title:"Properties: "+i},function(t){if(t){var i=window["fp_refreshNode"+n.ID];typeof i=="function"&&i();$(".fp_browser .fp_contactsEnumeration").each(function(n,t){var i={};i.typeBlock="ContactsEnumeration";i.classBlock="fp_contactsEnumeration";i.ID=$(t).closest(".flexpage-blockWrapper").attr("id");i.ID=parseInt(i.ID.replace("b",""));EventManager.tools.RefreshGrid(i)});$(".fp_browser .fp_folderContent").each(function(n,t){var i={};i.typeBlock="FolderContent";i.classBlock="fp_folderContent";i.ID=$(t).closest(".flexpage-blockWrapper").attr("id");i.ID=parseInt(i.ID.replace("b",""));EventManager.tools.RefreshGrid(i)})}})):n.event.item.name==="Refresh"?(f=window["fp_refreshNode"+n.ID],typeof f=="function"&&f()):n.event.item.name==="Copy"?(r=n.rowId,u={type:"folder",selectedIDs:r,action:"DeepCopy"},EventManager.tools.set_cookie("PWBrowserCopyData",JSON.stringify(u),1800)):n.event.item.name==="Cut"?(r=n.rowId,u={type:"folder",selectedIDs:r,action:"Cut"},EventManager.tools.set_cookie("PWBrowserCopyData",JSON.stringify(u),1800)):n.event.item.name==="Paste"?t.pasteItem(n,"DeepCopy"):n.event.item.name==="PasteShortcut"?t.pasteItem(n,"CopyShortcut"):n.event.item.name==="ExportContacts"?(window.flexpage=window.flexpage||{},window.flexpage.isSaveEven=!1,window.flexpage.onClose=function(){$("#dialog-iframe").remove()},window.flexpage.Download=function(n){$("#dialog-iframe").remove();location.href=n},$("<iframe/>",{id:"dialog-iframe",css:{position:"fixed",top:0,left:0,width:"100%",height:"100%",border:0,"z-index":12001},src:"/Export/ShowExportSettingsDialog?folderId="+n.rowId}).appendTo($("body"))):n.event.item.name==="ResetPublishingOverrides"?(n.requestUrl="Admin/DeletePublishingContactOverrides",n.folderID=parseInt(n.rowId),n.callbackSucceed=function(){},n.requestParameters={ID:n.ID,folderId:n.folderID},EventManager.bus.publish(EventManager.settings.Events.service.resetPublishingOverrides,n)):n.event.item.name==="ResetTimeToLeave"?(n.requestUrl="Admin/ObjectTimeToLeaveReset",n.folderID=parseInt(n.rowId),n.callbackSucceed=function(){},fp_ConfirmDialog("Reset time to leave","Do you want to make a recursive reset for all child objects?",function(){n.requestParameters={ID:n.ID,folderId:n.folderID,recursive:!0};EventManager.bus.publish(EventManager.settings.Events.service.resetTimeToLeave,n)},function(){n.requestParameters={ID:n.ID,folderId:n.folderID,recursive:!1};EventManager.bus.publish(EventManager.settings.Events.service.resetTimeToLeave,n)})):n.event.item.name==="OpenLocalVersion"&&n.path&&(e=n.path.replace(/\\/g,"/"),window.open("plurishell://show/"+e));return!1}}},{key:"renameApplyFolder",value:function(n){(n.event.type==="keydown"&&(n.event.which==13||n.event.keyCode==13)||n.event.type==="click"&&$(n.event.target).hasClass("fp_textTreeListNodeInput")===!1&&$(n.event.target).closest(".dxmLite").length===0)&&$(".fp_textTreeListNodeInput").each(function(i,r){if(n.typeBlock="FolderTreeList",n.classBlock="fp_folderTreeList",n.requestUrl="Flexpage/"+n.typeBlock+"_RenameApply",n.$row=$(r).closest(".fp_textTreeListNode"),n.ID=parseInt(n.$row.attr("data-id")),n.rowId=n.$row.attr("data-rowId"),n.$block=$(r).closest(".flexpage-blockWrapper#b"+n.ID),n.$block.find(".fp_freeze").length===0){if(n.newName=$(r).val(),n.newName==="")return;EventManager.tools.showLoading(n);n=t.getExtendedfolderID(n);n=t.getLevel(n);n.requestParameters={ID:n.ID,folderId:n.rowId,newName:n.newName,extendedfolderID:n.extendedfolderID,level:n.level,maxLevel:n.maxLevel};n.callbackSucceed=function(n,t,i,r){EventManager.tools.UpdateBlock(n,t,i,r);$(window.document).off("keydown",EventManager.tools.applyRename)};EventManager.bus.publish(EventManager.settings.Events.service.renameApplyFolder,n)}})}}],[{key:"bindUploadFile",value:function(n){return $('<input type="file" multiple>').on("change",function(){var i=new FormData,t;for(i.append("folderId",n.rowId),t=0;t<this.files.length;t++)i.append("file"+t,this.files[t]);for(t=0;t<this.files.length;t++)i.append("file"+t+"_dateModification",new Date(this.files[t].lastModifiedDate||this.files[t].lastModified||new Date).toISOString());n.requestParameters=i;fp_settings.debug==!0&&console.log(n.requestParameters.ID);n.$block=$(".fp_textTreeListNode[data-rowid="+n.rowId+"]").closest(".flexpage-blockWrapper").first();n.ID=n.$block.attr("id");n.ID=parseInt(n.ID.replace("b",""));n.requestParameters.append("id",n.ID);n.requestParameters.append("selectFolderName",n.path);n.callbackSucceed=function(n,t,i,r){$(".flexpage-block-container>.fp_folderContent").each(function(n,t){r.ID=$(t).closest(".flexpage-blockWrapper").attr("id");r.ID=parseInt(r.ID.replace("b",""));r.classBlock="fp_folderContent";EventManager.tools.RefreshGrid(r)})};n.callbackError=function(t,i,r,u,f){fp_ConfirmDialog(f.error.title,f.error.message,function(){f.error.overwrite==!0&&(u.requestParameters.append("overwrite",!0),EventManager.bus.publish(EventManager.settings.Events.service.uploadFile,u))},function(){n.callbackSucceed()})};EventManager.bus.publish(EventManager.settings.Events.service.uploadFile,n)}).click(),n}},{key:"pasteItem",value:function(n,t){var f=EventManager.tools.get_cookie("PWBrowserCopyData"),r,i,u;if(f==null){fp_WarningDialog("Error","You need to copy a file or a folder first");return}(r=JSON.parse(f),r.action=="Cut"&&EventManager.tools.delete_cookie("PWBrowserCopyData"),i=new FormData,i.append("IDsToCopy",r.selectedIDs),i.append("folderId",n.rowId),i.append("Type",r.type),i.append("Action",r.action=="Cut"?r.action:t),u=n.path,u)&&(i.append("selectFolderName",u),n.typeBlock="FolderTreeList",n.classBlock="fp_folderTreeList",n.requestUrl="Flexpage/Browser_Paste",n.requestParameters=i,EventManager.tools.showLoading(n),n.callbackSucceed=function(){var t,i;EventManager.tools.hideLoading(n);t=window["fp_refreshNode"+n.ID];typeof t=="function"&&t();i=$("#b"+n.ID+" ."+n.classBlock+"");i.removeClass("fp_freeze");$(".flexpage-block-container>.fp_folderContent").each(function(t,i){n.ID=$(i).closest(".flexpage-blockWrapper").attr("id");n.ID=parseInt(n.ID.replace("b",""));n.classBlock="fp_folderContent";EventManager.tools.RefreshGrid(n)})},EventManager.bus.publish(EventManager.settings.Events.service.paste,n))}},{key:"getRow",value:function(n){return n.$elemClick=$(".flexpage-blockWrapper#b"+n.ID+" ."+n.classBlock),n.$row=n.$elemClick.find(".fp_textTreeListNode[data-rowid="+n.rowId+"]"),n}},{key:"renameName",value:function(n){n=t.getRow(n);$(n.$row).html("<input  class='fp_textTreeListNodeInput' value='"+n.$row.html()+"' />");t.focus(n)}},{key:"focus",value:function(n){return n.$input=$(n.$row).find(".fp_textTreeListNodeInput"),n.$input.length===0&&(n.$input=$(n.$row).closest("li").find(".fp_textTreeListNodeInput")),EventManager.tools.focus(n)}},{key:"getExtendedfolderID",value:function(n){var t=$(".flexpage-blockWrapper#b"+n.ID+" .fp_folderTreeList");return n.extendedfolderID="",n.maxLevel=1,t.find(".fp_textTreeListNode:visible").map(function(t,i){if($(i).closest("li").find("ul .fp_textTreeListNode:visible").length>0){var r=$(i).attr("data-rowId"),u=parseInt($(i).attr("data-level"));r=parseInt(r);n.extendedfolderID+=r+",";u>n.maxLevel&&(n.maxLevel=u)}}),n}},{key:"getLevel",value:function(n){return n=t.getRow(n),n.level=parseInt($(n.$row).attr("data-level")),n}}]),t}(EventManagerBase);