"use strict";function _classCallCheck(n,t){if(!(n instanceof t))throw new TypeError("Cannot call a class as a function");}function _inherits(n,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);n.prototype=Object.create(t&&t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}});t&&(Object.setPrototypeOf?Object.setPrototypeOf(n,t):n.__proto__=t)}function _classCallCheck(n,t){if(!(n instanceof t))throw new TypeError("Cannot call a class as a function");}function _inherits(n,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);n.prototype=Object.create(t&&t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}});t&&(Object.setPrototypeOf?Object.setPrototypeOf(n,t):n.__proto__=t)}var _createClass=function(){function n(n,t){for(var i,r=0;r<t.length;r++)i=t[r],i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(n,i.key,i)}return function(t,i,r){return i&&n(t.prototype,i),r&&n(t,r),t}}(),_get=function(n,t,i){var e=!0,r,f,o;n:while(e){var u=n,s=t,h=i;if(e=!1,u===null&&(u=Function.prototype),r=Object.getOwnPropertyDescriptor(u,s),r===undefined){if(f=Object.getPrototypeOf(u),f===null)return undefined;n=f;t=s;i=h;e=!0;r=f=undefined;continue n}else return"value"in r?r.value:(o=r.get,o===undefined)?undefined:o.call(h)}},EventManager=EventManager||{},EventManagerContent=function(n){function t(){_classCallCheck(this,t);_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this)}return _inherits(t,n),_createClass(t,[{key:"updateByPathFolder",value:function(n,t){var i,u,f,e,r,o;return(n=EventManager.tools.getBrowser(n),i=n.$browser.find("[name="+n.typeBlock+"SelectFolderName]"),u=n.$browser.find("[name="+n.typeBlock+"SelectFolderNameLoad]"),i.val(n.path),n.$block=$(t).closest(".flexpage-blockWrapper"),f=n.$block.attr("id").replace("b",""),n.ID=parseInt(f),n.theme=n.$block.find("[name=DevExpressTheme]").val(),e=u.val(),e!=n.path||n.update==!0||n.initPerformCallback==!1)?(r=n.$block.find("table[id$=_Grid"+n.ID+"]"),o=r&&r.length>0?eval(r.attr("pwbrowser")):!1,EventManager.tools.showLoading(n),n.callbackSucceed=function(t,r,f){i=n.$browser.find("[name="+n.typeBlock+"SelectFolderName]").val();i==n.path&&(n.initPerformCallback!=!1&&u.val(n.path),EventManager.tools.UpdateBlock(t,r,f,n),EventManager.bus.publish(EventManager.settings.Events.folderContent.initUpload,n));EventManager.tools.hideLoading(n)},n.requestParameters={ID:n.ID,selectFolderName:n.path,theme:n.theme,TypeContextMenu:n.typeContextMenu,PWBrowser:o,initPerformCallback:n.initPerformCallback,filterCustomProperties:n.filterCustomProperties,filterExtension:n.filterExtension},n.publish=!0,n):(n.publish=!1,n)}},{key:"detailToggleButton",value:function(n){var e=$(n.event).attr("class"),u=$(n.event).closest("[class*=' dxgvDataRow'],[class^='dxgvDataRow']"),f=u.attr("class").split(" ").find(function(n){return n.search("dxgvDataRow")!=-1}).split("dxgvDataRow"),o=f[f.length-1],i,t,r;if($(n.event).hasClass("allowOnlyOneDetailRow")===!0&&$(n.event).hasClass("dxgvDetailButtonExpanded")===!1)for(i=$(".dxgvDetailButtonExpanded"),t=0;t<i.length;t++)$(i[t]).click();$(n.event).toggleClass("dxgvDetailButtonExpanded");r=u.attr("id").replace("ata","");$(n.event).hasClass("dxgvDetailButtonExpanded")===!0?$("#"+r).css({display:"table-row"}):$("#"+r).css({display:"none"})}},{key:"rowClick",value:function(){}}],[{key:"getRow",value:function(n){return n.$elemClick=$(".flexpage-blockWrapper#b"+n.ID+" ."+n.classBlock),n.$row=n.$elemClick.find(".fp_gridNameValue[data-rowid="+n.rowId+"]"),n}},{key:"renameName",value:function(n){if(EventManager.tools.showLoading(n),n=t.getRow(n),$(n.$row[0]).html("<input  class='fp_gridNameValueInput' value='"+n.$row.html()+"' />"),n.stopDownloadLink===!0){var i=$(n.$row).closest(".gvDownloadLink");i.length>0&&(i=i.first(),$(i).replaceWith($(n.$row)))}t.focus(n);EventManager.tools.hideLoading(n)}},{key:"focus",value:function(n){return n.$input=$(n.$row).find(".fp_gridNameValueInput"),EventManager.tools.focus(n),n}}]),t}(EventManagerBase),_get2,EventManagerFolderContent;_createClass=function(){function n(n,t){for(var i,r=0;r<t.length;r++)i=t[r],i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(n,i.key,i)}return function(t,i,r){return i&&n(t.prototype,i),r&&n(t,r),t}}();_get2=function(n,t,i){var e=!0,r,f,o;n:while(e){var u=n,s=t,h=i;if(e=!1,u===null&&(u=Function.prototype),r=Object.getOwnPropertyDescriptor(u,s),r===undefined){if(f=Object.getPrototypeOf(u),f===null)return undefined;n=f;t=s;i=h;e=!0;r=f=undefined;continue n}else return"value"in r?r.value:(o=r.get,o===undefined)?undefined:o.call(h)}};EventManager=EventManager||{};EventManagerFolderContent=function(n){function t(n){_classCallCheck(this,t);_get2(Object.getPrototypeOf(t.prototype),"constructor",this).call(this);EventManager.bus.subscribe(EventManager.settings.Events.folderContent.updateByPathFolder,this.updateByPathFolder);EventManager.bus.subscribe(EventManager.settings.Events.folderContent.showContextMenu,this.showContextMenu);EventManager.bus.subscribe(EventManager.settings.Events.folderContent.clickContextMenu,this.clickContextMenu);EventManager.bus.subscribe(EventManager.settings.Events.folderContent.renameApplyFile,this.renameApplyFile);EventManager.bus.subscribe(EventManager.settings.Events.folderContent.uploadFile,this.uploadFile);EventManager.bus.subscribe(EventManager.settings.Events.folderContent.detailToggleButton,this.detailToggleButton);EventManager.bus.subscribe(EventManager.settings.Events.folderContent.downloadZip,this.downloadZip);EventManager.bus.subscribe(EventManager.settings.Events.folderContent.endCallback,this.endCallback);n.allowUpload&&(EventManager.bus.subscribe(EventManager.settings.Events.folderContent.initUpload,this.initUpload),EventManager.bus.publish(EventManager.settings.Events.folderContent.initUpload,n));setTimeout(function(){EventManager.bus.publish(EventManager.settings.Events.folderContent.endCallback,n)},4e3)}return _inherits(t,n),_createClass(t,[{key:"endCallback",value:function(n){if(n.rowId=$("[class*='dxtlFocusedNode'] .fp_textTreeListNode").attr("data-rowid"),n.publish=!1,n=EventManager.tools.getBrowser(n),n.$browser.length>0&&n.rowId){var i=n.$browser.find(".flexpage-blockWrapper .fp_folderContent");n=_get(Object.getPrototypeOf(t.prototype),"updateByPathFolder",this).call(this,n,i[0])}n.refreshFiles&&t.refreshContent(n)}},{key:"initUpload",value:function(n){$("html").on("dragover",function(n){n.preventDefault();n.stopPropagation()});$("html").on("drop",function(n){n.preventDefault();n.stopPropagation()});$(".fp_folderContent .upload-area").on("drop",function(t){var r,i,u;for(t.stopPropagation(),t.preventDefault(),r=t.originalEvent.dataTransfer.files,n.requestParameters=new FormData,i=0;i<r.length;i++)n.requestParameters.append("file"+i,r[i]);for(i=0;i<r.length;i++)n.requestParameters.append("file"+i+"_dateModification",new Date(r[i].lastModifiedDate||r[i].lastModified||new Date).toISOString());(n.typeBlock="FolderContent",n.classBlock="fp_folderContent",n.$block=$(".flexpage-blockWrapper#b"+n.ID+" ."+n.classBlock),u=$(n.$block).find("#SelectFolderName").val()||$(n.$block).find("#PWFolderName").val(),u)&&(n.requestParameters.append("id",n.ID),n.dataID=n.ID,n.requestParameters.append("selectFolderName",u),n.requestParameters.append("folderId",n.rowId),n.callbackSucceed=function(n,t,i,r){EventManager.tools.RefreshGrid(r)},n.folderId=n.rowId,n.requestUrl="/Flexpage/FolderContent_UploadFile",n.callbackError=function(t,i,r,u,f){fp_ConfirmDialog(f.error.title,f.error.message,function(){f.error.overwrite==!0&&(u.requestParameters.append("overwrite",!0),EventManager.bus.publish(EventManager.settings.Events.service.uploadFile,u))},function(){n.callbackSucceed()})},EventManager.bus.publish(EventManager.settings.Events.service.uploadFile,n))})}},{key:"updateByPathFolder",value:function(n){var i,r;for(n.requestUrl="Flexpage/"+n.typeBlock+"_Update",n.classBlock="fp_folderContent",i=$(".flexpage-blockWrapper ."+n.classBlock),i.length==0&&fp_settings.debug==!0&&console.log("No "+n.classBlock+". maybe error updateByPathFolder"),r=0;r<i.length;r++)n=_get2(Object.getPrototypeOf(t.prototype),"updateByPathFolder",this).call(this,n,i[r]),n.publish==!0&&EventManager.bus.publish(EventManager.settings.Events.service.updateByPathFolder,n)}},{key:"showContextMenu",value:function(n){var f,i,e,r,t,o,u;if(n.blockCss="#fp_FolderContent_Grid"+n.ID+"_DXMainTable",f=n.event,f.type="click",EventManager.tools.applyRename(f),$(n.blockCss+" .fp_gridNameValueInput").length===0&&(n.$elemClick=$(n.event.htmlEvent.target),n.$block=n.$elemClick.closest("#b"+n.ID),n.$block.find(".fp_freeze").length===0)){for(n.classRow="fp_gridNameValue",n.folderPerm=n.$block.find("#FolderPermissions").val(),i=EventManager.tools.showContextMenu_CheckAttrs(n),i==null||(n=i),n.path=n.$block.find("[name='SelectFolderName']").val()||n.$block.find("[name='PWFolderName']").val(),n.path||(n.path="\\"),n.perm=parseInt(n.$elemClick.closest(".main_row").attr("data-perm")),isNaN(n.perm)&&(n.perm=0),EventManager.tools.showContextMenu_CopyAttrs(n),e=eval("PopupMenu"+n.ID),r=0;r<e.GetItemCount();r++)if(t=e.GetItem(r),n.typeContextMenu=="Browser"||n.typeContextMenu=="Block")switch(t.name){case"Create":t.SetVisible((n.perm&1)>0&&i!=null);break;case"UploadFile":t.SetVisible((n.folderPerm&1)>0);break;case"AddContact":t.SetVisible((n.perm&1)>0&&i!=null);break;case"Rename":t.SetVisible((n.perm&1)>0&&i!=null);break;case"Delete":t.SetVisible((n.perm&4)>0&&i!=null);break;case"Properties":t.SetVisible(i!=null);break;case"VersionHistory":t.SetVisible(i!=null);break;case"Download":t.SetVisible(i!=null);break;case"Copy":t.SetVisible(i!=null&&(n.perm&2)>0);break;case"Cut":t.SetVisible(i!=null&&(n.perm&4)>0&&(n.perm&2)>0);break;case"Paste":t.SetVisible(n.path!=="\\"&&(n.folderPerm&1)>0);t.SetEnabled(EventManager.tools.get_cookie("PWBrowserCopyData")!=null);break;case"PasteShortcut":t.SetVisible(n.path!=="\\"&&(n.folderPerm&1)>0);o=EventManager.tools.get_cookie("PWBrowserCopyData");o?(u=JSON.parse(o),t.SetEnabled(u!=null&&u.action!=="Cut"&&u.type!=="folder")):t.SetEnabled(!1)}else switch(t.name){case"Refresh":break;default:t.SetVisible(!1)}EventManager.tools.showContextMenu(n)}}},{key:"clickContextMenu",value:function(n){var i,o,f,h,u,e,s,r;if(n.typeBlock="FolderContent",n.classBlock="fp_folderContent",n.stopDownloadLink=!0,n.requestUrl="Flexpage/"+n.typeBlock+"_"+n.event.item.name,i=EventManager.tools.clickContextMenu_GetAttrs(n),i==null||(n=i),n.$elemClick=n.$block,n.BlockID=n.ID,o=n.$elemClick.find("#PWFolderName").val(),f=n.$elemClick.find("#SelectFolderName").val(),n.selectFolderName=f==""?o:f,n.requestParameters={ID:n.ID,fileId:n.rowId,selectFolderName:n.selectFolderName},h=$($(n.$elemClick).closest(".fp_folderContent[data-alias]")),n.event.item.name==="Properties"){if(i==null)return;fp_popupControlOpen({command:"edit",blocklistID:"0",blockType:"ObjectProperties",blockAlias:"",blockID:n.rowId,parameters:"file"},function(t){t&&EventManager.tools.RefreshGrid(n)})}else if(n.event.item.name==="Rename"){if(i==null)return;EventManagerContent.renameName(n);u=function u(t){if(t.keyCode===13&&(EventManager.tools.showLoading(n),EventManager.tools.applyRename(t),$(window.document).off("keydown",u)),t.keyCode===27){EventManager.tools.RefreshGrid(n);$(window.document).off("keydown",u);return}};$(window.document).on("keydown",u)}else if(n.event.item.name==="Delete"){if(i==null)return;r=$(n.$block).find("[class*='dxgvSelectedRow']");fp_settings.debug==!0&&console.log("$rows.length:"+r.length);r.length>0?fp_ConfirmDialog("Delete","Do you really want to delete the selected files?",function(){var i=r.length,t=0;r.each(function(r,u){EventManager.tools.showLoading(n);n.$row=$(u);n.rowId=$(n.$row).find(".fp_gridNameValue").attr("data-rowId");fp_settings.debug==!0&&console.log("rowId:"+n.rowId);n.callbackSucceed=function(){t++;fp_settings.debug==!0&&console.log("callbackSucceed indexCallback:"+t);t==i&&(fp_settings.debug==!0&&console.log("indexCallback == length"),EventManager.tools.RefreshGrid(n),EventManager.tools.hideLoading(n))};n.requestParameters={ID:n.ID,fileId:n.rowId,selectFolderName:n.selectFolderName};EventManager.bus.publish(EventManager.settings.Events.service.deleteFile,n)})}):fp_ConfirmDialog("Delete","Are you sure you want to delete file?",function(){EventManager.tools.showLoading(n);n.$row=n.$elemClick.find(".fp_gridNameValue[data-rowid="+n.rowId+"]").closest(".dxgvDataRow");n.callbackSucceed=function(t,i,r,u){EventManager.tools.RefreshGrid(u);EventManager.tools.hideLoading(n)};EventManager.bus.publish(EventManager.settings.Events.service.deleteFile,n)})}else if(n.event.item.name==="UploadFile")$('<input type="file" multiple>').on("change",function(){var i=new FormData,t,r;for(i.append("id",n.requestParameters.ID),t=0;t<this.files.length;t++)i.append("file"+t,this.files[t]);for(t=0;t<this.files.length;t++)i.append("file"+t+"_dateModification",new Date(this.files[t].lastModifiedDate||this.files[t].lastModified||new Date).toISOString());n.requestParameters=i;n.$block=$(".flexpage-blockWrapper#b"+n.ID+" ."+n.classBlock);r=$(n.$block).find("#SelectFolderName").val()||$(n.$block).find("#PWFolderName").val();n.requestParameters.append("selectFolderName",r);n.callbackSucceed=function(n,t,i,r){EventManager.tools.RefreshGrid(r)};n.callbackError=function(t,i,r,u,f){fp_ConfirmDialog(f.error.title,f.error.message,function(){f.error.overwrite==!0&&(u.requestParameters.append("overwrite",!0),EventManager.bus.publish(EventManager.settings.Events.service.uploadFile,u))},function(){n.callbackSucceed()})};EventManager.bus.publish(EventManager.settings.Events.service.uploadFile,n)}).click();else if(n.event.item.name==="VersionHistory"){if(i==null)return;e=$("td[data-rowid="+n.rowId+"] span");s=e.text()+e.data("ext");fp_popupControlOpen({command:"edit",blocklistID:"0",blockType:"FileHistory",blockAlias:"",blockID:n.rowId,title:"Versions of "+s,parameters:"file"})}else if(n.event.item.name==="Download"){if(i==null)return;r=$(n.$block).find("[class*='dxgvSelectedRow']");r.length>1?EventManager.bus.publish(EventManager.settings.Events.folderContent.downloadZip,{ID:n.ID}):window.location.href="/Flexpage/DownloadFile?id="+n.rowId+"&revisionID=0"}else if(n.event.item.name==="Refresh")t.refreshContent(n);else if(n.event.item.name==="Copy")eval("fp_FolderContent_Grid"+n.ID).GetSelectedFieldValues("ID",function(t){t&&t.length!==0||(t=[n.rowId]);var i={type:"files",selectedIDs:t.join(","),action:"DeepCopy"};EventManager.tools.set_cookie("PWBrowserCopyData",JSON.stringify(i),1800)});else if(n.event.item.name==="Cut")eval("fp_FolderContent_Grid"+n.ID).GetSelectedFieldValues("ID",function(t){t&&t.length!==0||(t=[n.rowId]);var i={type:"files",selectedIDs:t.join(","),action:"Cut"};EventManager.tools.set_cookie("PWBrowserCopyData",JSON.stringify(i),1800)});else if(n.event.item.name==="Paste")t.pasteItem(n,"DeepCopy");else if(n.event.item.name==="PasteShortcut")t.pasteItem(n,"CopyShortcut");else if(n.event.item.name==="OpenLocalVersion"&&n.path){var c=n.path.replace(/\\/g,"/"),l=$("span[data-blockid="+n.ID+"][data-id="+n.rowId+"]").html(),a=$("span[data-blockid="+n.ID+"][data-id="+n.rowId+"]").attr("data-ext");window.open("plurishell://show/"+c+"/"+l+a)}return!1}},{key:"renameApplyFile",value:function(n){return n.typeBlock="FolderContent",n.classBlock="fp_folderContent",n.classRow="fp_gridNameValue",n.stopDownloadLink=!0,n.event.type==="keydown"&&(n.event.which==13||n.event.keyCode==13)||n.event.type==="click"&&$(n.event.target).hasClass("fp_gridNameValueInput")===!1&&$(n.event.target).closest(".dxmLite").length===0?($(".fp_gridNameValueInput").each(function(t,i){if(n.requestUrl="Flexpage/"+n.typeBlock+"_RenameApply",n.$row=$(i).closest("."+n.classRow),n.ID=parseInt(n.$row.attr("data-id")),n.BlockID=parseInt(n.$row.attr("data-blockid")),n.rowId=n.$row.attr("data-rowId"),n.newName=$(i).val(),n.newName!==""){if(n.newName[n.newName.length-1]==="."){alert('Error in file name. The file name cannot end with "."');return}EventManager.tools.showLoading(n);var r=$($(n.$row).closest(".fp_folderContent[data-alias]"));n.selectFolderName=r.find("#SelectFolderName").val();n.requestParameters={ID:n.ID,fileId:n.rowId,newName:n.newName,selectFolderName:n.selectFolderName,BlockID:n.BlockID};n.callbackSucceed=function(t,r,u,f){n.$row.html($(i).val());f.ID=n.BlockID;EventManager.tools.RefreshGrid(f)};n.callbackError=function(t,i,r,u,f){u.ID=n.BlockID;EventManager.tools.RefreshGrid(u);EventManager.tools.CallbackError(t,i,r,n,f)};EventManager.bus.publish(EventManager.settings.Events.service.renameApplyFile,n);event.stopPropagation()}}),!1):void 0}},{key:"uploadFile",value:function(n){n.typeBlock="FolderContent";n.classBlock="fp_folderContent";n.stopDownloadLink=!0;_get2(Object.getPrototypeOf(t.prototype),"uploadFile",this).call(this,n)}},{key:"downloadZip",value:function(n){eval("fp_FolderContent_Grid"+n.ID).GetSelectedFieldValues("ID",function(n){if(!n||n.length===0){fp_ConfirmDialog("Warning","Please select files to upload",function(){});return}var t=n.join(",");window.location.href="/flexpage/FolderContentDownloadZip?ids="+t})}}],[{key:"refreshContent",value:function(n){var t=window["fp_refresh"+n.ID];typeof t=="function"&&t()}},{key:"pasteItem",value:function(n,t){var f=EventManager.tools.get_cookie("PWBrowserCopyData"),i,r,e,u;if(f==null){fp_WarningDialog("Error","You need to copy a file or a folder first");return}(i=JSON.parse(f),i.action=="Cut"&&EventManager.tools.delete_cookie("PWBrowserCopyData"),r=new FormData,r.append("IDsToCopy",i.selectedIDs),r.append("Type",i.type),r.append("Action",i.action=="Cut"?i.action:t),e=$(".flexpage-blockWrapper#b"+n.ID).find(".fp_folderTreeList[data-name]").attr("data-name"),fp_settings.debug==!0&&console.log(e),n.typeBlock="FolderContent",n.classBlock="fp_folderContent",n.$block=$(".flexpage-blockWrapper#b"+n.ID+" ."+n.classBlock),u=$(n.$block).find("#SelectFolderName").val()||$(n.$block).find("#PWFolderName").val(),u)&&(r.append("selectFolderName",u),n.requestUrl="Flexpage/Browser_Paste",n.requestParameters=r,EventManager.tools.showLoading(n),n.callbackSucceed=function(){EventManager.tools.hideLoading(n);EventManager.tools.RefreshGrid(n)},EventManager.bus.publish(EventManager.settings.Events.service.paste,n))}}]),t}(EventManagerContent);